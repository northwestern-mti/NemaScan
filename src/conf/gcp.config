nextflowVersion = '21.05.0-edge'

import java.time.*
Date now = new Date()

docker {
  enabled = true
  tty = true
}

process {
  executor = 'google-lifesciences'
  container = 'andersenlab/nemascan:v0.3'
  machineType = 'n1-standard-4'
  errorStrategy = { task.exitStatus==14 ? 'retry' : 'terminate' }   // retry if VM was preempted
  maxRetries = 5
  cache = 'deep'
}

google {
  project = 'andersen-lab'
  zone = 'us-central1-a'
  lifeSciences {
    serviceAccountEmail = 'nscalc-201573431837@andersen-lab.iam.gserviceaccount.com'
    debug = true
    preemptible = true
  }
}

executor {
  queueSize = 500
  submitRateLimit = 5
}

params.dataHash = 'none'

species     = "elegans"
wbb         = "WS276"

workDir = "gs://nf-pipelines/workdir"
projectDir = "gs://nf-pipelines/NemaScan"
inputFile = "gs://elegansvariation.org/reports/nemascan/${params.dataHash}/input.json"
outDir = "gs://elegansvariation.org/reports/nemascan/${params.dataHash}/output"
dataDir = "gs://nf-pipelines/NemaScan/input_data/${species}"
binDir = "gs://nf-pipelines/NemaScan/bin"
dataReleaseDir = "gs://elegansvariation.org/releases/20210121/variation"

// params
params {
  debug = false
  date = new Date().format( 'yyyyMMdd' )
  day = now.format("yyyMMdd")
  timestamp = now.format("yyyyMMdd-HH-mm-ss")
  
  out = "${outDir}/Analysis_Results"
  tracedir = "${outDir}/trace"
  numeric_chrom = "${projectDir}/input_data/all_species/rename_chromosomes"
  refflat = "${dataDir}/annotations/c_${species}_${wbb}_refFlat.txt"
  genes = "${binDir}/gene_ref_flat.Rda"

  // VCF files
  vcf = "${dataReleaseDir}/WI.20210121.hard-filter.isotype.vcf.gz"
  vcf_index = "${dataReleaseDir}/WI.20210121.hard-filter.isotype.vcf.gz.tbi"
  impute_vcf = "${dataReleaseDir}/WI.20210121.impute.isotype.vcf.gz"
  impute_vcf_index = "${dataReleaseDir}/WI.20210121.impute.isotype.vcf.gz.tbi"
  ann_file = "${dataReleaseDir}/WI.20210121.strain-annotation.bcsq.tsv"
  trait_file = "${inputFile}"
  isotype_file = "${dataDir}/isotypes/strain_isotype_lookup.tsv"

  // thresholds 
  cores = 4

  // mappings
  maps = "RUN"
  simulate = null
  lmm_exact = "RUN"
  lmm = "RUN"
  sparse_cut = 0.05
  maf = 0.05
  R_libpath = ""

  annotate = null
  simulate_qtlloc = null

  help = null
  e_mem = "10"
  eigen_mem = "10 GB"

  sparse_cut = 0.01
  group_qtl = 1000
  ci_size = 150
  sthresh = "BF"
  p3d = "TRUE"
  maf = 0.05

  freqUpper = 0.05
  minburden = 2
} 

report {
  enabled = true
  file = "${outDir}/report.html"
}

timeline {
  enabled = true
  file = "${outDir}/timeline.html"
}